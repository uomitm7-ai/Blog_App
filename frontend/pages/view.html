<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Post</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1><a href="index.html">MyBlog</a></h1>
            <div id="authNav"></div>
        </div>
    </nav>

    <div class="container single-post">
        <div id="post-content">Loading...</div>
    </div>

    <script src="../js/main.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');

        if (!postId) {
            document.getElementById('post-content').innerHTML = '<p>Invalid post ID.</p>';
        } else {
            checkAuth().then(user => {
                loadPost(postId, user);
            });
        }

        async function loadPost(id, user) {
            const res = await fetch(`/blog-app/backend/api/posts/get.php?id=${id}`);
            const post = await res.json();

            if (post.error) {
                document.getElementById('post-content').innerHTML = `<p>${post.error}</p>`;
                return;
            }

            let actions = '';
            if (user && user.id == post.user_id) {
                actions = `
                    <a href="edit.html?id=${post.id}">Edit</a>
                    <a href="#" id="deleteBtn">Delete</a>
                `;
            }

            document.getElementById('post-content').innerHTML = `
                <h1>${escapeHtml(post.title)}</h1>
                <p class="meta">By ${escapeHtml(post.username)} | 
                   Created: ${post.created_at} | Updated: ${post.updated_at}
                </p>
                <div class="content">${escapeHtml(post.content).replace(/\n/g, '<br>')}</div>
                <div class="actions">${actions}</div>
            `;

            if (user && user.id == post.user_id) {
                document.getElementById('deleteBtn').onclick = () => {
                    if (confirm('Delete this post?')) {
                        deletePost(id);
                    }
                };
            }
        }

        async function deletePost(id) {
            const res = await fetch('/blog-app/backend/api/posts/delete.php', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });
            const data = await res.json();
            if (data.success) {
                window.location.href = 'index.html';
            } else {
                alert(data.error || 'Delete failed');
            }
        }
    </script>
</body>
</html>